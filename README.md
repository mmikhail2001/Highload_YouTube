# Highload YouTube

## Содержание
* ### [1. Тема, целевая аудитория и расчет нагрузки](#1)
* ### [2. Логическая схема](#2)

## 1. Тема, аудитория и нагрузка <a name="1"></a>

### 1.1 Тема
Сервис **YouTube** - видеохостинг, предоставляющий пользователям услуги хранения, доставки и показа видео

### 1.2 MVP
Функциональность сервиса
1. **Просмотр** видео
2. **Загрузка** видео
3. **Комментирование, лайки, подписки** на канал
4. **Рекомендации** на главной странице и похожих видео на странице видео

> P.S. Авторизации происходят на стороне Google Аккаунт.

### 1.3 Целевая аудитория
- Местоположение - **Россия**
- **Размер аудитории** на локальном рынке \[[1](https://mediascope.net/data/#internet)]
	- месячный охват 95 млн. человек
	- дневной охват 52 млн. человек
- Среднее время просмотра в день - 88 мин.
	- ![|](../files/Pasted%20image%2020230909125310.png)
- Некоторые факты об аудитории
	- 15% доля YouTube в интернет-потреблении на локальном рынке (18% - доля видео в целом)
	- Средний возраст 25-34 лет
	- 47% - доля женщин

### 1.4 Расчет нагрузки

Статистика для расчетов

|Метрика|Аудитория|Значение|Обозначение|
| ------------- | --- |-------------|--|
|MAU (чел.)\[[1](https://mediascope.net/data/#internet)]|Мир|2500 млн.|MAU_WORLD|
|MAU (чел.)\[[1](https://mediascope.net/data/#internet)]|Россия|95 млн.|MAU_RUS|
|DAU (чел.)\[[1](https://mediascope.net/data/#internet)]|Россия|52 млн.|MAU_RUS|
|Количество просмотров / месяц \[[4](https://www.globalmediainsight.com/blog/youtube-users-statistics/#:~:text=YouTube%20Views%20by%20Country)]|Россия|207 млрд.|VIEWS_MONTH|
|Загрузка видео / день (час)\[[2](https://www.wyzowl.com/youtube-stats/#:~:text=4.4%20minutes.-,How%20many%20videos%20are%20uploaded%20to%20YouTube%20every%20day%3F,-Around%203.7m%20new)] |Мир|271 тыс.|UPLOAD_DAY|
|Передача видео / минуту (час)\[[10](https://www.wyzowl.com/youtube-stats/#:~:text=An%20average%20of%20694%2C000%20hours%20of%20video%20are%20streamed%20by%20YouTuber%20users%20each%20and%20every%20minute.%20This%20is%20even%20higher%20than%20Netflix%2C%20whose%20users%20stream%20452%2C000%20hours%20per%20minute.)] |Мир|694 тыс.|DOWNLOAD_MIN|
|Количество комментариев / 1000 просмотров\[[5](https://tubularlabs.com/blog/3-metrics-youtube-success/#:~:text=Comments%20to%20Views%3A%20How%20High%20is%20Engagement%3F)]|Мир|5|COMMENTS|
|Количество лайков / 100 просмотров\[[6](https://tubularlabs.com/blog/3-metrics-youtube-success/#:~:text=Likes%20to%20Views%3A%20How%20Popular%20is%20Your%20Video%3F)].|Мир|4|LIKES|
|Количество новых подписок / день / канал \[[7](https://medium.com/@jasonrbodie/average-youtube-channel-growth-rate-f6837584c9ac)]|Мир|1000|SUBS|
|Средняя продолжительность видео (мин)\[[8](https://bloggingwizard.com/youtube-statistics/#:~:text=7.-,The%20average%20length%20of%20a%20YouTube%20video%20is%2011.7%20minutes,-According%20to%20Statista)]|Мир|11.7|DURATION|
|Количество посещений страниц / день / пользователь \[[9](https://www.globalmediainsight.com/blog/youtube-users-statistics/#:~:text=An%20average%20YouTube%20visitor%20checks%20nearly%20nine%20pages%20per%20day.%C2%A0)]|Мир|9|VISITS_DAY_USER|

Некоторую метрику на российском рынке приблизительно можно считать равной 
- METRICS (rus) = METRICS (world) * (MAU / MAU)
- METRICS (rus) = METRICS (world) * K
- K = 95 / 2500 = 0.038

#### 1.4.1 Продуктовые метрики

|Действие пользователя |Количество / месяц|
| ------------- |-------------|
|Показ рекомендаций|276 млрд.|
|Просмотр видео|207 млрд.|
|Добавление лайка|8.28 млрд.|
|Подписка на канал|3.6 млрд.|
|Добавление комментария|1 млрд.|
|Загрузка видео на канал|1.6 млн.|

***Расчет cреднего количества действий пользователей по каждому типу***

- Просмотров видео - VIEWS_MONTH.
- Комментарии - 1 млрд. / мес.
	- На каждые 1000 просмотров приходится COMMENTS комментариев.
	- Значит, в месяц происходит ```VIEWS_MONTH / 1000 * COMMENTS = 207 млрд. / 1000 * 5 = 1 млрд``` запросов на добавление комментария.
- Лайки - 8.28 млрд. / мес.
	- На каждые 100 просмотров приходится LIKES лайков.
	- Значит, в месяц происходит ```VIEWS_MONTH / 100 * LIKES = 207 млрд. / 100 * 4 = 8.28 млрд``` запросов на установку лайка.
- Подписки - 3.6 млрд. / мес.
	- В среднем, каждый канал в день набирает SUBS подписчиков при MAU_WORLD активных пользователей в месяц.
	- Приблизительно, каждый канал на локальном рынке в день набирает ```SUBS * K = 1000 * 0.038 = 38```.
	- Значит, ```MAU_RUS * 38 = 95 млн * 38 = 3.6 млрд ```подписок осуществляется в месяц. 
- Загрузка видео - 1.6 млн. / мес.
	- В России загружается UPLOAD_DAY часов контента в день.
	- Каждое видео в среднем длится DURATION минут.
	- Следовательно, 1.6 млн. видеороликов в месяц загружаются на платформу.  
	- ```(`UPLOAD_DAY * 60) мин * 30 / DURATION = (10_300 час * 60) мин * 30 / 11.7 мин = 1.6 млн видео```
- Рекомендации -  276 млрд. / мес.
	- В среднем, каждый пользователь в день посещает VISITS_DAY_USER страниц сервиса.
	- Допустим, на каждые 3 посещения страницы видео приходится одно посещение главной страницы
	- Тогда, общее количество посещений этих страниц, а, следовательно, и предложенных рекомендаций 276 млрд. 
	- ```VIEWS_MONTH + VIEWS_MONTH * 1/3 = 207 + 207 * 1/3 = 276 млрд```

#### 1.4.2 Технические метрики

|Хранилище |Размер|
| ------------- |-------------|
|Видео (Пб / год) |81|
|Данные пользователя (Тб) |272|


|Тип запроса |RPS |
| ------------- |-------------|
|Главная страница|7 млн|
|Страница видео|7.6 млн|
|Добавление лайка|3200|
|Подписка на канал|1400|
|Добавление комментария|400|
|Загрузка видео на канал|60|

|Сетевой трафик |Потребление|
| ------------- |-------------|
|Среднее суточное (Пб / сутки) |326|
|Пиковое (Тбит / с)|90|

***Расчет технических метрик***
- Размер хранения
	- Во всем мире UPLOAD_DAY часов видео загружается на платформу каждый день. Значит, в России будет загружаться ```UPLOAD_DAY * K = 10_300 часов``` контента в день.
	- Допустим, все видео имеют разрешения 1080p с частотой кадров 30 fps в формате SDR. В хранилище хранятся все варианты разрешений для обеспечения адаптивного битрейта.
		- 1080p - 8 Mbps \[[3](https://support.google.com/youtube/answer/1722171?hl=en#zippy=%2Cframe-rate%2Cbitrate%2Cvideo-codec-h%2Cvideo-resolution-and-aspect-ratio%2Ccolor-space:~:text=Recommended%20video%20bitrates%20for%20SDR%20uploads)]
		- 720p - 5 Mbps                                                 
		- 480p - 2.5 Mbps
		- 360p - 1 Mbps
	- ```(10_300 час * 60 * 60) сек * (8 + 5 + 2.5 + 1) Mpbs / 8 / 1024 = 74 тыс. Гб```
	- В день 95 млн. человек загружают 74 тыс. Гб видео. Значит, каждый год требуется `74_000 * 365 = 27 Пб` памяти для хранения видео (не включая резервные копии)
	- Для обеспечения надежности хранения данных в S3 хранилище допустим, что каждое видео имеет 2 резервные копии. Таким образом, в год необходимо резервировать хранилище размером 81 Пб. 
	- Допустим, остальная информация пользователя (профиль, аватарка, данные о подписках, превью видео, описания видео, статистика по каналу и видео) занимает 3 Мб. `MAU_RUS * 3 Мб = 95 млн. * 3 Мб = 272 Тб`
- Потребление трафика
	- Загрузка главной страницы инициирует 65 запросов (8 API, 57 статика) и весит 15 Мб.
	- Загрузка страницы видео инициирует 95 запросов (30 API, 65 статика) и весит 25 Мб.
	- Выше нами было допущено, что в месяц главная страница открывается 1/3 * VIEWS_MONTH, а страница видео столько раз, сколько и просмотров, т.е. VIEWS_MONTH. 
		- `1/3 * VIEWS_MONTH * 15 Мб + VIEWS_MONTH * 25 Мб`
		- `1/3 * 207 млрд. * 15 + 207 млрд. * 25 Мб 6210 млрд. Мб = 5800 Пб`
		- `5800 / 30 = 193 Пб / сутки`
	- В среднем, DOWNLOAD_MIN часов видео транслируется каждую минуту. 
		- `(DOWNLOAD_MIN * K * 60 * 60) (сек/мин) / 60 (сек/сек) * 8 Mbps / 8 / 1024 = 1545 Гб / сек`
		- `1545 * 60 * 60 * 24 = 133 Пб / сутки`
	- Суммарное потребление `326 Пб / сутки`
	- Допустим, что пиковое потребление в 3 раза больше среднего, получим `(326_000 Тб / сутки * 3) / 24 / 60 / 60 * 8 = 90 Тбит / c`
- RPS по типам запросов

|Тип запрос |RPS|
| ------------- |-------------|
|Главная страница|`(276 млрд. / 30 / 24 / 60 / 60) * 65 = 7 млн`|
|Страница видео|`(207 млрд. / 30 / 24 / 60 / 60) * 95 = 7.6 млн`|
|Добавление лайка|`(8.28 млрд. / 30 / 24 / 60 / 60) = 3200`|
|Подписка на канал|`(3.6 млрд. / 30 / 24 / 60 / 60) = 1400`|
|Добавление комментария|`(1 млрд. / 30 / 24 / 60 / 60) = 400`|
|Загрузка видео на канал|`(1.6 млн. / 30 / 24 / 60 / 60) * 100 = 60`|

## 2. Логическая схема <a name="2"></a>

